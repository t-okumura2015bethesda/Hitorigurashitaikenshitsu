<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; color: #333; margin: 0; background: #f8f9fa; }
    /* 背景固定用のクラス */
    body.modal-open { overflow: hidden; position: fixed; width: 100%; }
    
    header { background: #007BBB; color: white; padding: 1rem; text-align: center; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #007BBB; background: white; border-radius: 5px; font-weight: bold; transition: 0.3s; flex: 1; min-width: 70px; text-align: center;}
    .tab-btn.active { background: #007BBB; color: white; }
    
    .map-outer-frame {
      width: 100%; height: 75vh; background: #eee; border-radius: 10px;
      overflow: hidden; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: center;
    }
    .map-wrapper { position: absolute; display: none; width: 100%; height: 100%; align-items: center; justify-content: center; }
    .map-wrapper.active { display: flex; }
    .map-img-container { position: relative; display: inline-block; line-height: 0; }
    .map-img { max-width: 100%; max-height: 75vh; width: auto; height: auto; display: block; border-radius: 5px; pointer-events: none; object-fit: contain; }
    
    .marker {
      position: absolute; width: 30px; height: 30px; 
      background: rgba(220, 50, 50, 0.6); color: white; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; transition: all 0.2s; 
      border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%); z-index: 5;
    }
    .marker-badge {
      position: absolute; top: -8px; right: -8px; background: #FFD700; color: #333;
      width: 18px; height: 18px; border-radius: 50%; font-size: 11px; font-weight: bold;
      line-height: 18px; text-align: center; border: 1px solid white;
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; touch-action: none; }
    .modal-content {
      position: relative; width: 95%; max-width: 1100px; margin: auto;
      background: white; border-radius: 12px; display: flex; flex-direction: column; 
      max-height: 96vh; overflow: hidden;
    }
    .img-container {
      width: 100%; height: 65vh; background: #000; position: relative;
      display: flex; align-items: center; justify-content: center; overflow: hidden;
    }
    .modal-img { max-width: 100%; max-height: 100%; object-fit: contain; will-change: transform; transition: transform 0.3s ease-out, opacity 0.3s; }
    .modal-text { width: 100%; padding: 20px 30px; background: #fff; box-sizing: border-box; overflow-y: auto; flex-grow: 1; }
    #v-room { margin: 0 0 5px 0; font-size: 1.4rem; color: #333; }
    #v-desc { font-size: 1rem; line-height: 1.6; color: #555; white-space: pre-wrap; margin: 0; }

    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.3); color: white; border: none; font-size: 30px; padding: 10px; cursor: pointer; z-index: 10; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
    .prev { left: 10px; } .next { right: 10px; }
    .slide-counter { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 3px 12px; border-radius: 15px; font-size: 13px; }
    .close-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 24px; font-weight: bold; color: #333; z-index: 101; background: rgba(255,255,255,0.9); width: 36px; height: 36px; line-height: 36px; text-align: center; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

    .thumb-section { margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px; }
    .tel-link { color: #007BBB; text-decoration: underline; cursor: pointer; }

    @media (max-width: 768px) {
      .marker { width: 16px !important; height: 16px !important; font-size: 10px !important; }
      .marker-badge { width: 11px !important; height: 11px !important; font-size: 8px !important; line-height: 11px !important; top: -6px !important; right: -6px !important; }
      .img-container { height: 55vh; }
      .modal-text { padding: 15px; }
      #v-room { font-size: 1.2rem; }
    }
  </style>
</head>
<body>

<header><h1>京都市一人暮らし体験室 オンライン内覧</h1></header>

<div class="container">
  <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid #007BBB; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <p style="margin: 0; line-height: 1.6;">間取り図の矢印や下の写真一覧から各部屋の様子をご覧いただけます。</p>
  </div>

  <div class="tabs">
    <div class="tab-btn active" onclick="switchFloor('外観')">外観</div>
    <div class="tab-btn" onclick="switchFloor('1F')">1階</div>
    <div class="tab-btn" onclick="switchFloor('2F')">2階</div>
    <div class="tab-btn" onclick="switchFloor('3F')">3階</div>
  </div>

  <div class="map-outer-frame" id="map-parent-frame">
    <div id="map-外観" class="map-wrapper active"><div class="map-img-container"><img src="IMG_7016.jpeg" class="map-img"><div id="markers-外観"></div></div></div>
    <div id="map-1F" class="map-wrapper"><div class="map-img-container"><img src="IMG_1818.JPG" class="map-img"><div id="markers-1F"></div></div></div>
    <div id="map-2F" class="map-wrapper"><div class="map-img-container"><img src="IMG_1825.jpeg" class="map-img"><div id="markers-2F"></div></div></div>
    <div id="map-3F" class="map-wrapper"><div class="map-img-container"><img src="IMG_1822.jpeg" class="map-img"><div id="markers-3F"></div></div></div>
  </div>

  <div class="thumb-section"><div id="floor-lists-container"></div></div>

  <footer style="margin-top: 50px; padding: 30px; background: #f1f3f5; text-align: center; border-radius: 10px; color: #555; font-size: 0.9rem;">
    <p style="font-weight: bold; margin-bottom: 5px;">障がい児・者相談支援センター「いまじん」</p>
    <p>電話：<span class="tel-link" onclick="location.href='tel:0755853217'">075-585-3217</span></p>
  </footer>
</div>

<div id="viewer" class="modal" onclick="closeViewer()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="closeViewer()">×</span>
    <div class="img-container">
      <button class="nav-btn prev" onclick="changeSlide(-1)">❮</button>
      <img id="v-img" class="modal-img">
      <button class="nav-btn next" onclick="changeSlide(1)">❯</button>
      <div id="v-counter" class="slide-counter"></div>
    </div>
    <div class="modal-text">
      <span id="v-floor" style="background:#eee; padding:2px 8px; border-radius:4px; font-size:11px; color:#666;"></span>
      <h2 id="v-room"></h2>
      <p id="v-desc"></p>
    </div>
  </div>
</div>

<script>
  const GAS_API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhXGnzIC2gE5UyWBguvXvQ67TDlhntpzzdh9Q4nV9kcwXOPo9XNaMj5WGE1J4U3PicNCAmqKRGZ1RVHQgSAcgX4JDJ23y3eFt7p0B_dVYQvCdG1ryQPBJ0SGUIZ2CNvhPD9WOlt523372OmzLxU2eYZ7nHqu4PS3pA-vutv_1L-i3b3UVJRoKcn0Zc_5v6wXYfQoZzG31Hnm5bN1s_BJ1VXrfh_78JKLSvY5ac4Np-VLiC1voGOj41k7yHVEhJ52ywmg39W43CMRhWcH_kFJKBzlRqnouNkX5b_Lxey&lib=Mp76_62xJm8fQqCNSnmRDrlyIfNZbfkjO";

  let allData = [], groupedData = {}, currentGroup = [], currentIndex = 0;
  let mScale = 1, mOffsetX = 0, mOffsetY = 0, mIsDragging = false, mStartX, mStartY, mInitialDist = 0;

  window.onload = function() {
    fetch(GAS_API_URL).then(res => res.json()).then(data => {
      let cleanData = data.filter(r => r[1] && r[3]);
      cleanData.sort((a, b) => a[1] === '外観' ? -1 : b[1] === '外観' ? 1 : a[1].localeCompare(b[1], undefined, {numeric:true}));
      allData = cleanData; processData(allData); renderMarkers(); renderFloorThumbs(allData); initMapControls();
    });
  };

  function initMapControls() {
    const f = document.getElementById('map-parent-frame');
    f.addEventListener('touchstart', e => {
      if (e.touches.length === 2) mInitialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      else if (e.touches.length === 1) { mIsDragging = true; mStartX = e.touches[0].pageX - mOffsetX; mStartY = e.touches[0].pageY - mOffsetY; }
    }, {passive:true});
    f.addEventListener('touchmove', e => {
      if (mScale > 1 || e.touches.length === 2) { if (e.cancelable) e.preventDefault(); } else { mIsDragging = false; return; }
      if (e.touches.length === 2) {
        let d = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        mScale = Math.min(Math.max(1, mScale * (d / mInitialDist)), 4); mInitialDist = d;
      } else if (mIsDragging) { mOffsetX = e.touches[0].pageX - mStartX; mOffsetY = e.touches[0].pageY - mStartY; }
      applyMapTransform();
    }, {passive:false});
    f.addEventListener('touchend', () => mIsDragging = false);
  }

  function applyMapTransform() {
    const t = document.querySelector('.map-wrapper.active .map-img-container');
    const f = document.getElementById('map-parent-frame');
    if (!t) return;
    if (mScale <= 1.01) { mScale = 1; mOffsetX = 0; mOffsetY = 0; } else {
      let lx = (f.clientWidth * (mScale - 1)) / 2, ly = (f.clientHeight * (mScale - 1)) / 2;
      mOffsetX = Math.min(Math.max(mOffsetX, -lx), lx); mOffsetY = Math.min(Math.max(mOffsetY, -ly), ly);
    }
    t.style.transform = `translate(${mOffsetX}px, ${mOffsetY}px) scale(${mScale})`;
  }

  function processData(data) {
    groupedData = {};
    data.forEach(r => { let k = r[1] + "-" + r[4]; if (!groupedData[k]) groupedData[k] = []; groupedData[k].push(r); });
  }

  function renderMarkers() {
    document.querySelectorAll('.marker').forEach(m => m.remove());
    let spots = {};
    allData.forEach(r => {
      if (r[1] === '外観' || !r[6]) return;
      let k = `${r[1]}-${r[6]}-${r[7]}`; if (spots[k]) return; spots[k] = true;
      let w = document.getElementById(`markers-${r[1]}`); if (!w) return;
      let m = document.createElement('div'); m.className = 'marker';
      m.style.left = r[6] + '%'; m.style.top = r[7] + '%';
      m.innerHTML = `<span style="transform: rotate(${r[8]||0}deg)">➔</span>`;
      let gk = r[1] + "-" + r[4], g = groupedData[gk];
      if (g && g.length > 1) { let b = document.createElement('div'); b.className = 'marker-badge'; b.innerText = g.length; m.appendChild(b); }
      m.onclick = e => { e.stopPropagation(); openViewer(gk, 0, false); };
      w.appendChild(m);
    });
  }

  function renderFloorThumbs(data) {
    let c = document.getElementById('floor-lists-container'), fls = {};
    data.forEach(r => { if (!fls[r[1]]) fls[r[1]] = []; fls[r[1]].push(r); });
    for (let f in fls) {
      let s = document.createElement('div'); s.style.marginBottom = "25px";
      s.innerHTML = `<h4 style="border-left:4px solid #007BBB; padding-left:10px; margin-bottom:10px;">${f}</h4>`;
      let g = document.createElement('div'); g.style = "display:grid; grid-template-columns:repeat(auto-fill, minmax(100px,1fr)); gap:8px;";
      fls[f].forEach(r => {
        let i = document.createElement('div'); i.innerHTML = `<img src="${r[3]}" style="width:100%; height:75px; object-fit:cover; border-radius:4px; cursor:pointer;">`;
        i.onclick = () => openViewer(null, allData.indexOf(r), true); g.appendChild(i);
      });
      s.appendChild(g); c.appendChild(s);
    }
  }

  const imgEl = document.getElementById('v-img'), viewEl = document.getElementById('viewer');
  let scale = 1, tStartX = 0, cTransX = 0, isPinch = false, inDist = 0, dX = 0, dY = 0, lStartX = 0, lStartY = 0;

  function openViewer(gk, idx, all) {
    currentGroup = all ? allData : groupedData[gk]; currentIndex = idx;
    updateViewer(true); viewEl.style.display = 'flex';
    document.body.classList.add('modal-open'); // 背景固定
  }

  function closeViewer() { 
    viewEl.style.display = 'none'; 
    document.body.classList.remove('modal-open'); // 背景固定解除
  }

  function updateViewer(init = false) {
    const item = currentGroup[currentIndex]; if(!item) return;
    imgEl.style.transition = 'none';
    if(!init) imgEl.style.opacity = 0; 
    setTimeout(() => {
      imgEl.src = item[3];
      document.getElementById('v-floor').innerText = item[1];
      document.getElementById('v-room').innerText = item[2];
      document.getElementById('v-desc').innerText = item[5] ? item[5].trim() : "";
      document.getElementById('v-counter').innerText = `${currentIndex + 1} / ${currentGroup.length}`;
      document.querySelectorAll('.nav-btn').forEach(b => b.style.display = currentGroup.length > 1 ? 'flex' : 'none');
      resetZoom();
      imgEl.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
      imgEl.style.opacity = 1;
    }, 50);
  }

  function changeSlide(n) {
    if (currentGroup.length <= 1) return;
    currentIndex = (currentIndex + n + currentGroup.length) % currentGroup.length;
    updateViewer();
  }

  function switchFloor(f) {
    document.querySelectorAll('.map-wrapper, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('map-' + f).classList.add('active');
    event.currentTarget.classList.add('active');
    mScale = 1; mOffsetX = 0; mOffsetY = 0; applyMapTransform();
  }

  viewEl.addEventListener('touchstart', e => {
    imgEl.style.transition = 'none';
    if (e.touches.length === 2) { isPinch = true; inDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); } 
    else { isPinch = false; tStartX = e.changedTouches[0].screenX; lStartX = e.changedTouches[0].screenX - dX; lStartY = e.changedTouches[0].screenY - dY; }
  }, {passive: false});

  viewEl.addEventListener('touchmove', e => {
    e.preventDefault(); // 背景スクロールを完全に阻止
    if (isPinch && e.touches.length === 2) { 
      let d = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      scale = Math.min(Math.max(1, scale * (d / inDist)), 4); inDist = d; updateTransform();
    } else if (!isPinch) {
      if (scale === 1) { cTransX = e.changedTouches[0].screenX - tStartX; updateTransform(); }
      else { dX = e.changedTouches[0].screenX - lStartX; dY = e.changedTouches[0].screenY - lStartY; updateTransform(); }
    }
  }, {passive: false});

  viewEl.addEventListener('touchend', e => {
    imgEl.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1), opacity 0.3s';
    if (isPinch) { if (e.touches.length === 0) isPinch = false; return; }
    if (scale === 1) { 
      let th = window.innerWidth * 0.2;
      if (cTransX < -th) { changeSlide(1); } else if (cTransX > th) { changeSlide(-1); } else { resetZoom(); }
    } else { updateTransform(); }
  }, {passive: true});

  function updateTransform() {
    if (scale > 1) {
      // 拡大時の移動制限（迷子防止）
      let limX = (imgEl.clientWidth * (scale - 1)) / 2, limY = (imgEl.clientHeight * (scale - 1)) / 2;
      dX = Math.min(Math.max(dX, -limX), limX); dY = Math.min(Math.max(dY, -limY), limY);
      imgEl.style.transform = `translate(${dX}px, ${dY}px) scale(${scale})`;
    } else {
      // スワイプ時の移動
      imgEl.style.transform = `translateX(${cTransX}px) scale(1)`;
    }
  }

  function resetZoom() { scale = 1; dX = 0; dY = 0; cTransX = 0; updateTransform(); }
</script>
</body>
</html>
